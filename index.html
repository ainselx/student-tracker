<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет учеников</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: white;
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-email {
            color: rgba(255,255,255,0.9);
            font-size: 0.85rem;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 500px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            margin-top: 10px;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
            padding: 8px 12px;
            font-size: 0.85rem;
            width: auto;
        }

        .btn-edit {
            background: #ffa502;
            color: white;
            padding: 8px 12px;
            font-size: 0.85rem;
            width: auto;
        }

        .student-list {
            margin-top: 10px;
        }

        .student-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }

        .student-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .student-subject {
            color: #667eea;
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .student-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #666;
        }

        @media (max-width: 400px) {
            .student-details {
                grid-template-columns: 1fr;
            }
        }

        .student-details span {
            background: #e8e8e8;
            padding: 6px 10px;
            border-radius: 6px;
        }

        .price-highlight {
            background: #d4edda !important;
            color: #155724 !important;
            font-weight: 600;
        }

        .student-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 30px;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        @media (max-width: 500px) {
            .summary {
                grid-template-columns: 1fr;
            }
        }

        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .summary-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        /* Auth styles */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-tab:first-child {
            border-radius: 8px 0 0 8px;
        }

        .auth-tab:last-child {
            border-radius: 0 8px 8px 0;
        }

        .auth-tab.active {
            background: white;
            color: #667eea;
        }

        .error-message {
            background: #ffe0e0;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading -->
        <div id="loadingView" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Загрузка...</p>
        </div>

        <!-- Auth View -->
        <div id="authView" class="auth-container hidden">
            <h1 style="text-align: center; margin-bottom: 20px;">Учет учеников</h1>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Вход</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Регистрация</button>
            </div>

            <div class="card">
                <div id="authError" class="error-message hidden"></div>
                <div id="authSuccess" class="success-message hidden"></div>

                <!-- Login Form -->
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Пароль</label>
                        <input type="password" id="loginPassword" required placeholder="Ваш пароль" minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginBtn">Войти</button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Пароль</label>
                        <input type="password" id="registerPassword" required placeholder="Минимум 6 символов" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Подтвердите пароль</label>
                        <input type="password" id="registerPasswordConfirm" required placeholder="Повторите пароль" minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary" id="registerBtn">Зарегистрироваться</button>
                </form>
            </div>
        </div>

        <!-- App View -->
        <div id="appView" class="hidden">
            <header>
                <h1>Учет учеников</h1>
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button class="btn-logout" onclick="handleLogout()">Выйти</button>
                </div>
            </header>

            <!-- Статистика -->
            <div class="card">
                <div class="summary">
                    <div class="summary-item">
                        <div class="summary-value" id="totalStudents">0</div>
                        <div class="summary-label">Учеников</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="totalLessons">0</div>
                        <div class="summary-label">Занятий/мес</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="totalIncome">0</div>
                        <div class="summary-label">Доход/мес</div>
                    </div>
                </div>
            </div>

            <!-- Форма добавления -->
            <div class="card">
                <h2 id="formTitle">Добавить ученика</h2>
                <form id="studentForm">
                    <input type="hidden" id="editId">

                    <div class="form-group">
                        <label>ФИО ученика</label>
                        <input type="text" id="name" required placeholder="Иванов Иван">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Телефон</label>
                            <input type="tel" id="phone" placeholder="+7 999 123-45-67">
                        </div>
                        <div class="form-group">
                            <label>Предмет</label>
                            <input type="text" id="subject" required placeholder="Математика">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Оплата в месяц (руб)</label>
                            <input type="number" id="monthlyPayment" required min="0" placeholder="8000">
                        </div>
                        <div class="form-group">
                            <label>Занятий в месяц</label>
                            <input type="number" id="lessonsPerMonth" required min="1" placeholder="8">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Длительность занятия (мин)</label>
                        <select id="lessonDuration">
                            <option value="45">45 минут</option>
                            <option value="60" selected>60 минут (1 час)</option>
                            <option value="90">90 минут (1.5 часа)</option>
                            <option value="120">120 минут (2 часа)</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">Добавить</button>
                    <button type="button" class="btn btn-secondary hidden" id="cancelBtn" onclick="cancelEdit()">Отмена</button>
                </form>
            </div>

            <!-- Список учеников -->
            <div class="card">
                <h2>Список учеников</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Поиск по имени или предмету...">
                </div>
                <div class="student-list" id="studentList">
                    <div class="empty-state">Загрузка...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase конфигурация
        const SUPABASE_URL = 'https://uqqllcehzwgohlgwxfxh.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_yF3d-O6nbeIubgVkFsOxfw_yTqAexOD';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Данные
        let students = [];
        let currentUser = null;

        // DOM элементы
        const loadingView = document.getElementById('loadingView');
        const authView = document.getElementById('authView');
        const appView = document.getElementById('appView');
        const studentList = document.getElementById('studentList');
        const searchInput = document.getElementById('searchInput');
        const form = document.getElementById('studentForm');

        // Инициализация
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                currentUser = session.user;
                showApp();
            } else {
                showAuth();
            }

            // Слушаем изменения авторизации
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    showApp();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    showAuth();
                }
            });
        }

        // Показать экран авторизации
        function showAuth() {
            loadingView.classList.add('hidden');
            authView.classList.remove('hidden');
            appView.classList.add('hidden');
        }

        // Показать приложение
        async function showApp() {
            loadingView.classList.add('hidden');
            authView.classList.add('hidden');
            appView.classList.remove('hidden');

            document.getElementById('userEmail').textContent = currentUser.email;
            await loadStudents();
        }

        // Переключение табов авторизации
        function showAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));

            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authSuccess').classList.add('hidden');

            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }

        // Показать ошибку
        function showError(message) {
            const el = document.getElementById('authError');
            el.textContent = message;
            el.classList.remove('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        // Показать успех
        function showSuccess(message) {
            const el = document.getElementById('authSuccess');
            el.textContent = message;
            el.classList.remove('hidden');
            document.getElementById('authError').classList.add('hidden');
        }

        // Вход
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Вход...';

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showError(error.message === 'Invalid login credentials'
                    ? 'Неверный email или пароль'
                    : error.message);
                btn.disabled = false;
                btn.textContent = 'Войти';
            }
        }

        // Регистрация
        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.textContent = 'Регистрация...';

            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showError('Пароли не совпадают');
                btn.disabled = false;
                btn.textContent = 'Зарегистрироваться';
                return;
            }

            const { error } = await supabase.auth.signUp({ email, password });

            if (error) {
                showError(error.message);
            } else {
                showSuccess('Проверьте email для подтверждения регистрации!');
                document.getElementById('registerForm').reset();
            }

            btn.disabled = false;
            btn.textContent = 'Зарегистрироваться';
        }

        // Выход
        async function handleLogout() {
            await supabase.auth.signOut();
        }

        // Загрузка учеников
        async function loadStudents() {
            const { data, error } = await supabase
                .from('students')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading students:', error);
                return;
            }

            students = data || [];
            renderStudents();
            updateSummary();
        }

        // Расчет стоимости одного занятия
        function calculateLessonPrice(monthlyPayment, lessonsPerMonth) {
            if (lessonsPerMonth <= 0) return 0;
            return Math.round(monthlyPayment / lessonsPerMonth);
        }

        // Обновление статистики
        function updateSummary() {
            const totalStudents = students.length;
            const totalLessons = students.reduce((sum, s) => sum + s.lessons_per_month, 0);
            const totalIncome = students.reduce((sum, s) => sum + s.monthly_payment, 0);

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalLessons').textContent = totalLessons;
            document.getElementById('totalIncome').textContent = totalIncome.toLocaleString('ru-RU');
        }

        // Отрисовка списка учеников
        function renderStudents(filter = '') {
            const filtered = students.filter(s =>
                s.name.toLowerCase().includes(filter.toLowerCase()) ||
                s.subject.toLowerCase().includes(filter.toLowerCase())
            );

            if (filtered.length === 0) {
                studentList.innerHTML = '<div class="empty-state">' +
                    (filter ? 'Ничего не найдено' : 'Список пуст. Добавьте первого ученика!') +
                    '</div>';
                return;
            }

            studentList.innerHTML = filtered.map(student => {
                const lessonPrice = calculateLessonPrice(student.monthly_payment, student.lessons_per_month);

                return `
                    <div class="student-item">
                        <div class="student-name">${escapeHtml(student.name)}</div>
                        <div class="student-subject">${escapeHtml(student.subject)}</div>
                        <div class="student-details">
                            <span>${student.phone || 'Нет телефона'}</span>
                            <span>${student.lessons_per_month} зан/мес × ${student.lesson_duration} мин</span>
                            <span>${student.monthly_payment.toLocaleString('ru-RU')} руб/мес</span>
                            <span class="price-highlight">${lessonPrice.toLocaleString('ru-RU')} руб/занятие</span>
                        </div>
                        <div class="student-actions">
                            <button class="btn btn-edit" onclick="editStudent('${student.id}')">Изменить</button>
                            <button class="btn btn-danger" onclick="deleteStudent('${student.id}')">Удалить</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Защита от XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Добавление/редактирование ученика
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;

            const studentData = {
                name: document.getElementById('name').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                subject: document.getElementById('subject').value.trim(),
                monthly_payment: parseInt(document.getElementById('monthlyPayment').value),
                lessons_per_month: parseInt(document.getElementById('lessonsPerMonth').value),
                lesson_duration: parseInt(document.getElementById('lessonDuration').value)
            };

            const editId = document.getElementById('editId').value;

            if (editId) {
                // Редактирование
                const { error } = await supabase
                    .from('students')
                    .update(studentData)
                    .eq('id', editId);

                if (error) {
                    alert('Ошибка сохранения: ' + error.message);
                    submitBtn.disabled = false;
                    return;
                }
                cancelEdit();
            } else {
                // Добавление
                studentData.user_id = currentUser.id;

                const { error } = await supabase
                    .from('students')
                    .insert([studentData]);

                if (error) {
                    alert('Ошибка добавления: ' + error.message);
                    submitBtn.disabled = false;
                    return;
                }
            }

            form.reset();
            document.getElementById('lessonDuration').value = '60';
            submitBtn.disabled = false;

            await loadStudents();
        });

        // Редактирование ученика
        function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;

            document.getElementById('editId').value = student.id;
            document.getElementById('name').value = student.name;
            document.getElementById('phone').value = student.phone || '';
            document.getElementById('subject').value = student.subject;
            document.getElementById('monthlyPayment').value = student.monthly_payment;
            document.getElementById('lessonsPerMonth').value = student.lessons_per_month;
            document.getElementById('lessonDuration').value = student.lesson_duration;

            document.getElementById('formTitle').textContent = 'Редактирование';
            document.getElementById('submitBtn').textContent = 'Сохранить';
            document.getElementById('cancelBtn').classList.remove('hidden');

            form.scrollIntoView({ behavior: 'smooth' });
        }

        // Отмена редактирования
        function cancelEdit() {
            document.getElementById('editId').value = '';
            form.reset();
            document.getElementById('lessonDuration').value = '60';
            document.getElementById('formTitle').textContent = 'Добавить ученика';
            document.getElementById('submitBtn').textContent = 'Добавить';
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        // Удаление ученика
        async function deleteStudent(id) {
            if (!confirm('Удалить этого ученика?')) return;

            const { error } = await supabase
                .from('students')
                .delete()
                .eq('id', id);

            if (error) {
                alert('Ошибка удаления: ' + error.message);
                return;
            }

            if (document.getElementById('editId').value === id) {
                cancelEdit();
            }

            await loadStudents();
        }

        // Поиск
        searchInput.addEventListener('input', function() {
            renderStudents(this.value);
        });

        // Запуск
        init();
    </script>
</body>
</html>
